<script>
    const [upload, setFile] = () => {
        let file = null;

        const file_info = document.querySelector(".upload_status section p");
        const progress = document.querySelector(".upload_status section progress");

        const upload() {
            Promise.resolve(file)
                .then((file) => {
                    if (!file)
                        throw new Error("File not set");
                    if (file.size > 1e9)
                        throw new Error("File exceeds 1GB");

                    return file;
                })
                .then((file) => {
                    file_info.innerHTML = "uploading file ";
                    file_info.appendChild(document.createTextNode(file.name));

                    progress.value = 0;
                    progress.innerHTML = "Waiting for connection";

                    return file;
                })
                .then((file) => {
                    var reader = new FileReader();

                    reader.readAsBinaryString(file);
                    return new Promise((res, rej) => {
                        reader.on("load", () => res(reader));
                        reader.on("error", rej);
                    })
                })
                .then(
                    (reader) => {
                        xhr.open("POST", "/upload");
                        xhr.upload.addEventListener("progress", (e) => {
                            if (e.lengthComputable) {
                                progress.value = Math.round((e.loaded * 100) / e.total);
                                progress.innerHTML = "Uploading, " + progress.value + " completed";
                            }
                        }, false);

                        return new Promise((res, rej) => {
                            xhr.upload.addEventListener("load", function(e) {
                                res;
                            }, false);
                            xhr.upload.on("error", rej);
                        });
                    }
                )
                .then(() => {
                    progress.value = 100;
                    progress.innerHTML = "Upload completed";
                })
                .catch(() => {
                    progress.innerHTML = "UPLOAD FAILED!";
                });

            return false;
        }

        const setFile(files) {
            file = files[0];
        }

    );
</script>

<form id="myform" name="myform">
    <label for="f1_dir">DirName:</label><input id="f1_dir" type="text" name="dirname" value="johndoe">
    <label for="f1_file">File</label><input id="f1_file" type="file" name="dirname" onchange="setFile(this.files);">
    <button onclick="return upload(this.form);">Upload</button>
</form>

<article id="upload_status">
    <header>Upload status</header>
    <section>
        <p>Waiting for file</p>
        <progress min="0" max="100" value="0">-</progress>
    </section>
</article>
